<!DOCTYPE html>
<html lang="en">
  <head>
    <title>{% block head %}SimpleTix{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Algolia -->
    <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"></script>

    <style>
      #hits {
        position: absolute;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
      }
      .hit { padding: 8px 10px; border-bottom: 1px solid #eee; cursor: pointer; }
      .hit:hover { background: #f5f5f5; }
      .hit-title { font-weight: bold; }
      .hit-artist { color: #333; }
      .hit-venue { color: #777; font-size: 13px; }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'simpletix:index' %}">SimpleTix(Logo)</a>
        <div class="collapse navbar-collapse" id="navbarNav">

          <!-- ‚úÖ Algolia-compatible search -->
          <form class="d-flex position-relative" role="search" onsubmit="return false;">
            <div id="searchbox" class="me-2"></div>
            <div id="hits"></div>
          </form>

          <!-- ‚úÖ Keep all teammate‚Äôs original nav items -->
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Events
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{% url 'simpletix:webpage' 'Find Event Page' %}">Find Event</a></li>
                <li><a class="dropdown-item" href="{% url 'events:event_list' %}">Event List</a></li>
                <li><a class="dropdown-item" href="{% url 'events:create_event' %}">Create Event</a></li>
              </ul>
            </li>
          </ul>

          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              {% if user.is_authenticated %}
              <a class="nav-link" href="{% url 'simpletix:webpage' 'Logout Page' %}">Logout</a>
              {% else %}
              <a class="nav-link" href="{% url 'simpletix:webpage' 'Login Page' %}">Login</a>
              {% endif %}
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container">{% block body %}{% endblock %}</main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ‚úÖ Your Algolia logic -->
    <script>
      const search = instantsearch({
        indexName: 'simpletix_Event',
        searchClient: algoliasearch('KFIC62EZAO', 'f1809fe722a615014200b52e256b5576'),
      });

      const hitsContainer = document.getElementById('hits');
      const MAX_RESULTS = 8;

      search.addWidgets([
        instantsearch.widgets.searchBox({
          container: '#searchbox',
          placeholder: 'Search by title, artist, or venue...',
          showReset: false,
          showSubmit: false,
        }),
        instantsearch.widgets.hits({
          container: '#hits',
          templates: {
            item(hit) {
              return `
                <div class="hit">
                  <div class="hit-title">${instantsearch.highlight({ attribute: 'title', hit })}</div>
                  <div class="hit-artist">${instantsearch.highlight({ attribute: 'artist', hit })}</div>
                  <div class="hit-venue">üìç ${instantsearch.highlight({ attribute: 'venue', hit })}</div>
                </div>`;
            },
          },
          transformItems(items) {
            return items.slice(0, MAX_RESULTS);
          },
        }),
      ]);

      search.start();

      search.on('render', () => {
        const hits = hitsContainer.querySelectorAll('.hit');
        const query = document.querySelector('.ais-SearchBox-input')?.value.trim();
        hitsContainer.style.display = hits.length > 0 && query !== '' ? 'block' : 'none';
      });

      document.addEventListener('click', (event) => {
        const isClickInside =
          document.getElementById('searchbox').contains(event.target) ||
          hitsContainer.contains(event.target);
        if (!isClickInside) hitsContainer.style.display = 'none';
      });

      console.log("Algolia initialized ‚úÖ");
    </script>
  </body>
</html>
